name: Deploy to Server

on:
  push:
    branches:
      - main  # 当推送到main分支时触发
  workflow_dispatch:  # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up pnpm and Node.js
        uses: pnpm/action-setup@v3
        with:
          version: 8
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'frontend/pnpm-lock.yaml'
      
      - name: Build Vue Frontend
        run: |
          cd frontend
          pnpm install
          pnpm run build
          echo "✓ 前端构建完成"
      
      - name: Deploy Backend to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e  # 遇到错误立即退出
            
            # 设置部署目录
            BACKEND_DIR="/root/detest"
            PROJECT_NAME="AutoTopicSum"
            
            echo "=== 开始部署后端 ==="
            
            # 创建后端部署目录（如果不存在）
            mkdir -p $BACKEND_DIR
            cd $BACKEND_DIR
            
            # 克隆或拉取最新代码
            if [ -d "$PROJECT_NAME/.git" ]; then
              echo "拉取最新代码..."
              cd $PROJECT_NAME
              git reset --hard
              git pull origin main
            else
              echo "克隆仓库..."
              rm -rf $PROJECT_NAME
              git clone https://github.com/${{ github.repository }}.git $PROJECT_NAME
              cd $PROJECT_NAME
            fi
            
            cd $BACKEND_DIR/$PROJECT_NAME/backend
            
            # 安装Python依赖
            echo "安装Python依赖..."
            pip install -r requirements.txt
            
            # 创建日志目录
            mkdir -p logs
            
            # 停止旧的后端服务
            echo "停止旧的后端服务..."
            pkill -f "python.*run.py" || true
            sleep 2
            
            # 启动后端服务
            echo "启动后端服务..."
            nohup python run.py > logs/backend.log 2>&1 &
            echo "✓ 后端服务已启动（PID: $!）"
            echo "后端运行在: http://localhost:5001"
      
      - name: Deploy Frontend to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          source: "frontend/dist/*"
          target: "/www/wwwroot/de-test.linxin.blog/"
          strip_components: 2
          rm: true